{% extends 'layout.html' %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('static',filename='styles/log_events.css') }}" type="text/css">
{% endblock %}

{% block body_tab %}

{% from "includes/_formhelpers.html" import render_field %}



<div class="container-fluid" id="form-container">
  <br /> <br /> <br /> <br />
  <span><h3>Log Events</h3> (showing {{line_limit}} rows) <button class="btn btn-primary" id="show_filter">Show Filter</button></span>

    <form method="POST" action="" id="filter_form">
      <div class="row">
        <div class="col-xs-12 col-sm-2 form-group">
          <label for="run_id_filter">Run ID (✔ for latest):</label><br />
          <div class="flex">
            {{render_field(form2.run_id_filter, class_="form-control clear-field")}}
            {{render_field(form2.run_id_latest, class_="form-control clear-field2", id="exception")}}
          </div>
        </div>
        <div class="col-xs-12 col-sm-3 form-group">
          <label for="thread_name_filter">Thread Name:</label><br />
          <div class="flex">
            {{render_field(form2.thread_name_filter, class_="form-control clear-field")}}
          </div>
        </div>
        <div class="col-xs-12 col-sm-4 form-group">
          <label for="timestamp_operator">Timestamp:</label><br />
          <div class="flex">
            {{render_field(form2.timestamp_operator, class_="form-control operator")}}
            {{render_field(form2.timestamp_filter, class_="form-control field_width clear-field")}}
          </div>

        </div>
        <div class="col-xs-12 col-sm-3 form-group">
          <label for="level_operator">Level:</label><br />
          <div class="flex">
            {{render_field(form2.level_operator, class_="form-control operator")}}
            {{render_field(form2.level_filter, class_="form-control field_width clear-field")}}
          </div>
        </div>
      </div>



      <div class="row">
        <div class="col-xs-12 col-sm-2 form-group">
          <label for="line_limit">Row Limit:</label><br />
          <div class="flex">
            {{render_field(form2.line_limit, class_="form-control")}}
          </div>
        </div>
        <div class="col-xs-12 col-sm-2 form-group">
          <label for="culprit_operator">Culprit:</label><br />
          <div class="flex">
            {{render_field(form2.culprit_filter, class_="form-control clear-field")}}
          </div>
        </div>
        <div class="col-xs-12 col-sm-3 form-group">
          <label for="pathname_operator">Pathname:</label><br />
          <div class="flex">
            {{render_field(form2.pathname_filter, class_="form-control clear-field")}}
          </div>
        </div>
        <div class="col-xs-12 col-sm-3 form-group">
          <label for="lineno_operator">Line Number:</label><br />
          <div class="flex">
            {{render_field(form2.lineno_operator, class_="form-control operator")}}
            {{render_field(form2.lineno_filter, class_="form-control field_width clear-field")}}
          </div>

        </div>
        <div class="col-xs-12 col-sm-2 form-group">
          <label for="user_id_operator">User ID:</label><br />
          <div class="flex">
            {{render_field(form2.user_id_filter, class_="form-control clear-field")}}
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-xs-12 col-sm-2 form-group">
          <label for="email_operator">Email:</label><br />
          <div class="flex">
            {{render_field(form2.email_filter, class_="form-control clear-field")}}
          </div>
        </div>
        <div class="col-xs-12 col-sm-4 form-group">
          <label for="message_operator">Message:</label><br />
          <div class="flex">
            {{render_field(form2.message_filter, class_="form-control clear-field")}}
          </div>
        </div>
        <div class="col-xs-12 col-sm-3 form-group">
          <label for="exception_operator">Exception (✔ for all w/ exception):</label><br />
          <div class="flex">
            {{render_field(form2.exception_filter, class_="form-control clear-field")}}
            {{render_field(form2.exception_check, class_="form-control clear-field2", id="exception")}}
          </div>
        </div>
        <div class="col-xs-12 col-sm-3 form-group">
          <label for="stacktrace_operator">Stacktrace:</label><br />
          <div class="flex">
            {{render_field(form2.stacktrace_filter, class_="form-control clear-field")}}
          </div>
        </div>
      </div>

      <div class="filter-button-group">
        <button class="btn btn-primary filter-buttons" id="clear" type="button">Clear</button>
        <button type="submit" value="Filter" class="btn btn-primary filter-buttons">Filter</button>

      </div>
    </form>

</div>

<div class="container-fluid">



  <table class="table table-hover table-condensed table-responsive">
          <thead>
            <tr>
              <th>RID</th>
              <th>Thread name (click for details)</th>
              <th><div class="timestamp-table">Timestamp</div></th>
              <th>Path</th>
              <th>Email</th>
              <th>Message (click to expand rows)</th>
              <th>Exception</th>
            </tr>
          </thead>
          <tbody>
            {% for row2, timestamp, message, exception, collapsable in rows2 %}
            {% if row2.level > 50 %}
              {% if collapsable == 1 %}
              <tr class="row_level_50 collapsable">
              {% else %}
              <tr class="row_level_50">
              {% endif %}
            {% elif row2.level >= 40 %}
              {% if collapsable == 1 %}
              <tr class="row_level_40 collapsable">
              {% else %}
              <tr class="row_level_40">
              {% endif %}
            {% elif row2.level >= 30 %}
              {% if collapsable == 1 %}
              <tr class="row_level_30 collapsable">
              {% else %}
              <tr class="row_level_30">
              {% endif %}
            {% elif row2.level >= 20 %}
              {% if collapsable == 1 %}
              <tr class="row_level_20 collapsable">
              {% else %}
              <tr class="row_level_20">
              {% endif %}
            {% elif row2.level >= 10 %}
            {% if collapsable == 1 %}
              <tr class="row_level_10 collapsable">
              {% else %}
              <tr class="row_level_10">
              {% endif %}
            {% else %}
              {% if collapsable == 1 %}
              <tr class="collapsable">
              {% else %}
              <tr class="">
              {% endif %}
            {% endif %}
                <td>{{row2.run_id}}</td>
                <td class="clickable-row" data-href="log_events/{{row2.id}}">{{row2.thread_name}}</td>
                <td><div class="timestamp-table">{{timestamp}}</div></td>
                <td>{{row2.pathname}}, line {{row2.lineno}}</td>
                <td>{{row2.email}}</td>
                {% if collapsable == 2%}
                <td class="parent-row">
                {% else %}
                <td>
                {% endif %}
                  {% if collapsable == 2%}
                  <span class="glyphicon glyphicon-collapse-down"></span>
                  {% endif %}
                  {{message}}
                </td>
                <td>{{exception}}</td>
              </tr>
            {% endfor %}
          </tbody>
  </table>

</div>
{% endblock %}







{% block js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.3.1/vue.min.js"></script>
<script src="https://raw.github.com/jmosbech/StickyTableHeaders/master/js/jquery.stickytableheaders.min.js"></script>
<script>
$(function(){
  $("#show_filter").click(function() {
    if ($.trim($(this).text()) === 'Show Filter') {
      $(this).text('Hide Filter');
    } else {
        $(this).text('Show Filter');
    }
    $("#filter_form").toggle();
  });

  $(".clickable-row").click(function() {
        var url = $(this).data("href");
        window.open(url);
  });
  $("#clear").click(function() {
    $(".clear-field").val("");
    $( ".clear-field2").prop('checked', false);
  });

  $(".parent-row").click(function() {
    $(this).closest('tr').nextUntil(':not(.collapsable)').slideToggle()
    if($(this).children().hasClass("glyphicon-collapse-down")){
      $(this).children().removeClass("glyphicon-collapse-down")
      $(this).children().addClass("glyphicon-collapse-up")
    } else if ($(this).children().hasClass("glyphicon-collapse-up")) {
      $(this).children().removeClass("glyphicon-collapse-up")
      $(this).children().addClass("glyphicon-collapse-down")
    }
  });

  $('table').stickyTableHeaders();

})

</script>
{% endblock %}
